<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css"
      integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
      crossorigin="anonymous">
<link href="~/content/markdown/markdown-editor.css" rel="stylesheet">

<link href="~/Content/rating/rating.css" media="all" rel="stylesheet" type="text/css" />

@model FinalTest.Domain.Contracts.ViewModels.PostViewModel

@{
    ViewBag.PostId = Model.Id;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>@Model.Title</h2>


<h4>@Resources.Resource.By <em>@Html.ActionLink(Model.AuthorName, "Display", "Profile", new { id = Model.AuthorId }, null)  @Model.Created</em></h4>
<hr />


@if (Model.IsRatable)
{
    using (Ajax.BeginForm("Rate", new AjaxOptions { UpdateTargetId = "testrating2" }))
    {
        <div id="testrating2">
            <input data-val="true" id="PostId" name="PostId" type="hidden" value="@Model.Id" />

            <input id="RateValue" name="RateValue" value="@Model.Rating" />


        </div>

    }
}
else
{
    <input id="RateValue" name="RateValue" value="@Model.Rating" readonly="true" />
}



<div>


    <dl class="dl-horizontal">


        <dt>
            @Html.DisplayNameFor(model => model.Description)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Description)
        </dd>


        <dt>
            @Html.DisplayNameFor(model => model.SectionName)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.SectionName)
        </dd>


        @foreach (var tag in Model.Tags)
        {
            @Html.ActionLink("#" + tag.Name + ", ", "DisplayNews", "Tag", new { id = tag.Id }, null);
        }



    </dl>
</div>

<div class="row">
    <div class="col-md-12">

        <div class="col-md-12">
            <textarea cols="365" class="form-control markdown" id="Text" name="Text" rows="15"
                      data-use-twemoji="true" data-default-mode="preview">@Model.Text</textarea>

        </div>
    </div>
</div>



@if (Model.IsCommentable)
{



    using (Ajax.BeginForm("AddComment", new AjaxOptions { UpdateTargetId = "add-comments" }))
    {
        <div class="panel panel-default" style="margin-bottom:16px; margin-top:16px;">
            <div class="panel-heading">
                <button type="submit" class="btn btn-success btn-sm">@Resources.Resource.AddComment</button>
            </div>
            <div class="panel-body">

                <p>
                    <textarea cols="60" rows="4" id="Body" name="Body"></textarea>
                </p>


                <input data-val="true" id="PostId" name="PostId" type="hidden"
                       value="@Model.Id" />


            </div>
        </div>
    }


    <div id="add-comments" style="margin-bottom:16px; margin-top:16px;"></div>
}



<div style="margin-top: 8px; margin-bottom: 8px">

</div>
@foreach (var item in Model.Comments)
{


    <div class="panel panel-default" id="comm-@item.Id">
        <div class="panel-heading">
            <h3 class="panel-title">@Html.DisplayFor(modelItem => item.AuthorName)</h3>
        </div>
        <div class="panel-body">
            <p>@Html.DisplayFor(modelItem => item.Body)</p>

            <div class="row" id="testtable-@item.Id">
                @if (item.IsLikable)
                {

                    <div class="col-md-1">
                        @using (Ajax.BeginForm("Like", new AjaxOptions { UpdateTargetId = "comm-" + item.Id }))
                        {
                            <span id="testlike-@item.Id">
                                <input id="CommentId" name="CommentId" type="hidden" value="@item.Id" />

                                <button type="submit" class="btn btn-success btn-sm">
                                    <span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span>
                                    <span>@item.LikesAmount</span>
                                </button>

                            </span>
                        }
                    </div>
                    <div class="col-md-1">
                        @using (Ajax.BeginForm("Dislike", new AjaxOptions { UpdateTargetId = "comm-" + item.Id }))
                        {
                            <span id="testlike-@item.Id">
                                <input id="CommentId" name="CommentId" type="hidden" value="@item.Id" />

                                <button type="submit" class="btn btn-danger btn-sm">
                                    <span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span>
                                    <span>@item.DislikesAmount</span>
                                </button>

                            </span>
                        }
                    </div>


                }
                else
                {
                    <div class="col-md-1">
                        <span class="glyphicon glyphicon-thumbs-up" style="color:green" aria-hidden="true"></span>
                        <span style="color:green">@item.LikesAmount</span>

                        <span class="glyphicon glyphicon-thumbs-down" style="color:red" aria-hidden="true"></span>
                        <span style="color:red">@item.DislikesAmount</span>
                    </div>

                }
                <div class="col-md-1">
                    @if (item.IsEditable)
                    {
                        using (Ajax.BeginForm("DeleteComment", new AjaxOptions { UpdateTargetId = "comm-" + item.Id }))
                        {
                            <input id="Id" name="Id" type="hidden" value="@item.Id" />
                            <button type="submit" class="btn btn-danger btn-sm">
                                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                            </button>
                        }
                    }


                </div>
            </div>
        </div>


    </div>





}


<div id="commentfield"></div>

<p>

</p>
@section scripts
    {

    <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
    <script src="~/signalr/js"></script>
    <script src="~/signalr/hubs"></script>
    <script src="~/Scripts/Mustache/mustache.js"></script>


    <script id="commentTpl" type="text/template">        
        <div class="panel panel-default" id="comm-{{cid}}">
            <div class="panel-heading">
                <h3 class="panel-title">{{cauthorname}}</h3>
            </div>
            <div class="panel-body">
                <p>{{cbody}}</p>

                <div class="row" id="testtable-{{cid}}">
                    <div class="col-md-1">
                        <form action="/News/Like" data-ajax="true" data-ajax-mode="replace" 
                              data-ajax-update="#testtable-{{cid}}" id="form1" method="post">
                            <span id="testlike-{{cid}}">
                                <input id="CommentId" name="CommentId" type="hidden" value="{{cid}}" />

                                <button type="submit" class="btn btn-success btn-sm">
                                    <span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span>
                                    <span>{{clikesamount}}</span>
                                </button>

                            </span>
                        </form>
                    </div>
                    <div class="col-md-1">
                        <form action="/News/Dislike" data-ajax="true" data-ajax-mode="replace" 
                              data-ajax-update="#testtable-{{cid}}" id="form2" method="post">
                                                           
                                <span id="testlike-{{cid}}">
                                    <input id="CommentId" name="CommentId" type="hidden" value="{{cid}}" />

                                    <button type="submit" class="btn btn-danger btn-sm">
                                        <span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span>
                                        <span>{{cdislikesamount}}</span>
                                    </button>

                                </span>
                        </form>
                    </div>

                </div>
            </div>
        </div>

    </script >

    

    <script type="text/javascript">
        $(function () {

            var commenthub = $.connection.commentHub;
            

            commenthub.client.displayComment = function (body, authorname, likesamount,dislikesamount, id) {
                
                var template = $('#commentTpl').html();
                    var comment= {
                        cbody: body,
                        cauthorname: authorname,
                        clikesamount: likesamount,
                        cdislikesamount: dislikesamount,
                        cid: id
                    };

                var html = Mustache.to_html(template, comment)

                $('#commentfield').append(html);
               
                

            };

            $.connection.hub.start();

        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
            integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
            crossorigin="anonymous"></script>
    <!-- Markdown IT Main Library -->
    <script src="~/scripts/markdown/markdown-it.min.js"></script>
    <!-- Markdown IT Definition List Plugin -->
    <script src="~/scripts/markdown/markdown-it-deflist.min.js"></script>
    <!-- Markdown IT Footnote Plugin -->
    <script src="~/scripts/markdown/markdown-it-footnote.min.js"></script>
    <!-- Markdown IT Abbreviation Plugin -->
    <script src="~/scripts/markdown/markdown-it-abbr.min.js"></script>
    <!-- Markdown IT Subscript Plugin -->
    <script src="~/scripts/markdown/markdown-it-sub.min.js"></script>
    <!-- Markdown IT Superscript Plugin -->
    <script src="~/scripts/markdown/markdown-it-sup.min.js"></script>
    <!-- Markdown IT Underline/Inserted Text Plugin -->
    <script src="~/scripts/markdown/markdown-it-ins.min.js"></script>
    <!-- Markdown IT Mark Plugin -->
    <script src="~/scripts/markdown/markdown-it-mark.min.js"></script>
    <!-- Markdown IT SmartArrows Plugin -->
    <script src="~/scripts/markdown/markdown-it-smartarrows.min.js"></script>
    <!-- Markdown IT Checkbox Plugin -->
    <script src="~/scripts/markdown/markdown-it-checkbox.min.js"></script>
    <!-- Markdown IT East Asian Characters Line Break Plugin -->
    <script src="~/scripts/markdown/markdown-it-cjk-breaks.min.js"></script>
    <!-- Markdown IT Emoji Plugin -->
    <script src="~/scripts/markdown/markdown-it-emoji.min.js"></script>
    <script src="https://twemoji.maxcdn.com/2/twemoji.min.js"></script>
    <script src="~/scripts/markdown/markdown-editor-cut.js"></script>

    <script src="~/Scripts/rating/star-rating.min.js" type="text/javascript"></script>

    <script>
        // initialize with defaults
        $("#RateValue").rating();

        // with plugin options
        $("#RateValue").rating({ min: 1, max: 5, step: 1, size: 'lg' , stars: @Model.Rating});
    </script>


    <script>
        $(document).ready(function () {
            $("#RateValue").on('rating:change', function () {
                $("#form0").submit(); // Submit the form
            });
        });
    </script>
}
